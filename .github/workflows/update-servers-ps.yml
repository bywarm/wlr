name: Update Configs Hourly (Windows)

on:
  schedule:
    - cron: '0 */2 * * *'
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      folder_name:
        description: '–ò–º—è –ø–∞–ø–∫–∏ –¥–ª—è –∫–æ–Ω—Ñ–∏–≥–æ–≤'
        required: false
        default: 'confs'

env:
  # –û–±—â–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (–æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å)
  MY_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  GITVERSE_TOKEN: ${{ secrets.GITVERSE_TOKEN }}
  CLOUD_RU_SECRET_KEY: ${{ secrets.CLOUD_RU_SECRET_KEY }}
  OUTPUT_DIR: ${{ github.event.inputs.folder_name || 'confs' }}

  # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ (–º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å —Ç–µ –∂–µ)
  MODE: single
  LINKS_FILE: links.txt
  OUTPUT_FILE: available
  OUTPUT_ADD_DATE: 'false'
  MAX_WORKERS: 600
  EXPORT_FORMAT: txt
  ENABLE_CACHE: 'false'
  TEST_URLS: http://www.google.com/generate_204,http://www.cloudflare.com/cdn-cgi/trace
  TEST_URLS_HTTPS: https://www.gstatic.com/generate_204
  REQUIRE_HTTPS: 'false'
  STRONG_STYLE_TEST: 'false'
  STRONG_STYLE_TIMEOUT: 12
  STRONG_MAX_RESPONSE_TIME: 3
  STRONG_DOUBLE_CHECK: 'true'
  STRONG_ATTEMPTS: 3
  REQUESTS_PER_URL: 1
  MIN_SUCCESSFUL_REQUESTS: 1
  MIN_SUCCESSFUL_URLS: 1
  REQUEST_DELAY: 0.1
  CONNECT_TIMEOUT: 6
  CONNECT_TIMEOUT_SLOW: 15
  USE_ADAPTIVE_TIMEOUT: 'false'
  MAX_RETRIES: 1
  MAX_RESPONSE_TIME: 10
  MIN_RESPONSE_SIZE: 0
  MAX_LATENCY_MS: 2000
  VERIFY_HTTPS_SSL: 'false'
  STABILITY_CHECKS: 2
  STABILITY_CHECK_DELAY: 2
  STRICT_MODE: 'true'
  STRICT_MODE_REQUIRE_ALL: 'true'
  TEST_POST_REQUESTS: 'false'
  SPEED_TEST_ENABLED: 'false'
  XRAY_STARTUP_WAIT: 1.8
  XRAY_STARTUP_POLL_INTERVAL: 0.2
  BASE_PORT: 20000

jobs:
  update:
    runs-on: self-hosted  # –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤–∞—à Windows-—Ä–∞–Ω–Ω–µ—Ä
    timeout-minutes: 15
    permissions:
      contents: write

    steps:
    - name: ‚¨áÔ∏è Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # PowerShell —Ç–µ–ø–µ—Ä—å –¥–æ—Å—Ç—É–ø–µ–Ω, –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø–æ–ª–∏—Ç–∏–∫—É –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (–µ—Å–ª–∏ –µ—â—ë –Ω–µ —Å–¥–µ–ª–∞–Ω–æ)
    - name: ‚öôÔ∏è Set PowerShell execution policy (temporary)
      run: Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope Process -Force
      shell: powershell

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º Python (—É–∂–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)
    - name: üêç Verify Python installation
      run: python --version
      shell: powershell

    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (pip –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å)
    - name: üì¶ Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install PyGithub requests urllib3 boto3 aiohttp tqdm pyyaml
      shell: powershell

    - name: üöÄ Run merge script
      run: python scripts/simple_merge.py
      shell: powershell
      env:
        OUTPUT_DIR: ${{ env.OUTPUT_DIR }}

    - name: üìÑ Verify merged.txt exists
      run: |
        if (-Not (Test-Path "$env:OUTPUT_DIR/merged.txt")) {
            Write-Host "‚ùå merged.txt not found!"
            exit 1
        }
        $lines = (Get-Content "$env:OUTPUT_DIR/merged.txt" | Measure-Object -Line).Lines
        Write-Host "merged.txt –≥–æ—Ç–æ–≤, —Å—Ç—Ä–æ–∫: $lines"
        Write-Host "–ü–µ—Ä–≤—ã–µ 5 —Å—Ç—Ä–æ–∫ merged.txt:"
        Get-Content "$env:OUTPUT_DIR/merged.txt" -TotalCount 5
      shell: powershell

    # –°–æ–∑–¥–∞—ë–º raw_links.txt (–±–µ–∑ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤) –ø—Ä—è–º–æ –∏–∑ merged.txt
    - name: üìÑ Prepare raw links (without fragment)
      run: |
        Get-Content "$env:OUTPUT_DIR/merged.txt" | Where-Object { $_ -match '^vless://' } | ForEach-Object { $_ -replace '#.*$', '' } | Where-Object { $_ -ne '' } | Set-Content raw_links.txt
        $raw = (Get-Content raw_links.txt | Measure-Object -Line).Lines
        Write-Host "–°—ã—Ä—ã—Ö —Å—Å—ã–ª–æ–∫: $raw"
        if ($raw -eq 0) {
            Write-Host "‚ùå –ù–µ—Ç –≤–∞–ª–∏–¥–Ω—ã—Ö —Å—Å—ã–ª–æ–∫!"
            exit 1
        }
        Write-Host "–ü—Ä–∏–º–µ—Ä –ø–µ—Ä–≤—ã—Ö –¥–≤—É—Ö —Å—ã—Ä—ã—Ö —Å—Å—ã–ª–æ–∫:"
        Get-Content raw_links.txt -TotalCount 2
      shell: powershell

    - name: üîç Run vless_checker on raw links
      env:
        LINKS_FILE: raw_links.txt
        # –ú–æ–∂–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ª—é–±—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
      run: python vless_checker.py
      shell: powershell

    # –î–∞–ª–µ–µ –≤–∞—à–∏ —à–∞–≥–∏ speedtest –∏ –∫–æ–º–º–∏—Ç–∞ (–æ–Ω–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–µ—Ä–µ–ø–∏—Å–∞–Ω—ã –ø–æ–¥ PowerShell –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ)
    # –ü—Ä–∏–º–µ—Ä –¥–ª—è speedtest (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω):
    - name: ‚ö° Run speedtest on configs/available
      if: env.SPEED_TEST_ENABLED == 'true'
      run: python speedtest_checker.py configs/available
      shell: powershell
      env:
        SPEED_TEST_ENABLED: ${{ env.SPEED_TEST_ENABLED }}
        # ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ

    - name: üîÅ Replace available with speedtest result
      if: env.SPEED_TEST_ENABLED == 'true'
      run: |
        if (Test-Path "configs/available_st") {
            Move-Item -Force "configs/available_st" "configs/available"
            if (Test-Path "configs/available_st(top100)") {
                Move-Item -Force "configs/available_st(top100)" "configs/available(top100)"
            } else {
                Get-Content "configs/available" -TotalCount 100 | Set-Content "configs/available(top100)"
            }
            Write-Host "‚úÖ Speedtest results applied"
        } else {
            Write-Host "‚ö†Ô∏è Speedtest produced no output, keeping original available"
        }
      shell: powershell

    - name: üìå Add checked files to git
      run: |
        git add configs/available configs/available(top100) configs/notworkers
      shell: powershell
      continue-on-error: true   # –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ —Ñ–∞–π–ª–æ–≤ –Ω–µ—Ç

    - name: üíæ Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git config --local pull.rebase true

        git add "$env:OUTPUT_DIR/*"
        git add README.md

        $status = git diff --cached --quiet
        if ($LASTEXITCODE -eq 0) {
            Write-Host "üîÑ –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
            exit 0
        }

        $MOSCOW_TIME = (Get-Date).ToUniversalTime().AddHours(3).ToString("HH:mm | dd.MM.yyyy")
        git commit -m "ü§ñ –ê–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: $MOSCOW_TIME"

        Write-Host "üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å —É–¥–∞–ª–µ–Ω–Ω—ã–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–º..."
        git pull --rebase origin main
        if ($LASTEXITCODE -ne 0) {
            git rebase --abort
            git pull origin main --strategy-option ours
        }

        Write-Host "üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è..."
        $MAX_RETRIES = 3
        $RETRY_DELAY = 10
        for ($i=1; $i -le $MAX_RETRIES; $i++) {
            Write-Host "–ü–æ–ø—ã—Ç–∫–∞ $i –∏–∑ $MAX_RETRIES..."
            git push origin main
            if ($LASTEXITCODE -eq 0) {
                Write-Host "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã"
                break
            } else {
                Write-Host "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ, –ø–æ–ø—ã—Ç–∫–∞ $i –Ω–µ —É–¥–∞–ª–∞—Å—å"
                if ($i -lt $MAX_RETRIES) {
                    Write-Host "‚è≥ –ñ–¥–µ–º $RETRY_DELAY —Å–µ–∫—É–Ω–¥..."
                    Start-Sleep -Seconds $RETRY_DELAY
                    git pull origin main --rebase
                } else {
                    Write-Host "üí• –í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–µ —É–¥–∞–ª–∏—Å—å"
                    exit 1
                }
            }
        }
      shell: powershell
