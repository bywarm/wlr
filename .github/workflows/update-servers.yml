name: Update confs Hourly

on:
  schedule:
    - cron: '0 */2 * * *'
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      folder_name:
        description: '–ò–º—è –ø–∞–ø–∫–∏ –¥–ª—è –∫–æ–Ω—Ñ–∏–≥–æ–≤'
        required: false
        default: 'confs'

env:
  # –û–±—â–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–æ—Å—Ç–æ–≥–æ –º–µ—Ä–∂-—Å–∫—Ä–∏–ø—Ç–∞
  MY_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  GITVERSE_TOKEN: ${{ secrets.GITVERSE_TOKEN }}
  CLOUD_RU_SECRET_KEY: ${{ secrets.CLOUD_RU_SECRET_KEY }}
  OUTPUT_DIR: ${{ github.event.inputs.folder_name || 'confs' }}

  # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è Xray-–ø—Ä–æ–≤–µ—Ä–∫–∏ (vless_checker.py –∏ speedtest_checker.py)
  MODE: merge
  LINKS_FILE: links.txt
  OUTPUT_FILE: available
  OUTPUT_ADD_DATE: 'false'
  MAX_WORKERS: 600
  EXPORT_FORMAT: txt
  ENABLE_CACHE: 'false'
  TEST_URLS: http://www.google.com/generate_204,http://www.cloudflare.com/cdn-cgi/trace
  TEST_URLS_HTTPS: https://www.gstatic.com/generate_204
  REQUIRE_HTTPS: 'false'
  STRONG_STYLE_TEST: 'false'
  STRONG_STYLE_TIMEOUT: 12
  STRONG_MAX_RESPONSE_TIME: 3
  STRONG_DOUBLE_CHECK: 'true'
  STRONG_ATTEMPTS: 3
  REQUESTS_PER_URL: 1
  MIN_SUCCESSFUL_REQUESTS: 1
  MIN_SUCCESSFUL_URLS: 1
  REQUEST_DELAY: 0.1
  CONNECT_TIMEOUT: 6
  CONNECT_TIMEOUT_SLOW: 15
  USE_ADAPTIVE_TIMEOUT: 'false'
  MAX_RETRIES: 1
  MAX_RESPONSE_TIME: 10
  MIN_RESPONSE_SIZE: 0
  MAX_LATENCY_MS: 2000
  VERIFY_HTTPS_SSL: 'false'
  STABILITY_CHECKS: 2
  STABILITY_CHECK_DELAY: 2.0
  STRICT_MODE: 'true'
  STRICT_MODE_REQUIRE_ALL: 'true'
  TEST_POST_REQUESTS: 'false'

  # Speedtest
  SPEED_TEST_ENABLED: 'false'
  SPEED_TEST_TIMEOUT: 2
  SPEED_TEST_MODE: full
  SPEED_TEST_METRIC: latency
  SPEED_TEST_OUTPUT: separate_file
  SPEED_TEST_REQUESTS: 5
  SPEED_TEST_URL: https://www.gstatic.com/generate_204
  SPEED_TEST_WORKERS: 600
  SPEED_TEST_DOWNLOAD_TIMEOUT: 30
  SPEED_TEST_DOWNLOAD_URL_SMALL: https://speed.cloudflare.com/__down?bytes=250000
  SPEED_TEST_DOWNLOAD_URL_MEDIUM: https://speed.cloudflare.com/__down?bytes=1000000
  MIN_SPEED_THRESHOLD_MBPS: 1
  SPEED_TEST_DEBUG: 'false'
  XRAY_STARTUP_WAIT: 1.8
  XRAY_STARTUP_POLL_INTERVAL: 0.2
  BASE_PORT: 20000

jobs:
  update:
    runs-on: self-hosted
    timeout-minutes: 30
    permissions:
      contents: write

    steps:
    - name: ‚¨áÔ∏è Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Show info
      run: echo "üïê –ó–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞..."
      shell: bash

    - name: Check Python installation
      run: python --version
      shell: bash
      continue-on-error: true   # –µ—Å–ª–∏ Python –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –Ω–µ –ø–∞–¥–∞–µ–º

    - name: Test connection to GitHub
      run: |
        curl -I https://github.com
        curl -I https://raw.githubusercontent.com
      shell: bash
      continue-on-error: true

    - name: Set up Python
      uses: actions/setup-python@v5   # –∏—Å–ø–æ–ª—å–∑—É–µ–º v5
      with:
        python-version: '3.11'
        cache: pip

    - name: üì¶ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install PyGithub requests urllib3 boto3 aiohttp tqdm pyyaml PySocks python-dotenv rich pydantic

    - name: üöÄ Run merge script
      run: |
        echo "üïê –ó–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞..."
        echo "üìÅ –ò—Å–ø–æ–ª—å–∑—É–µ–º–∞—è –ø–∞–ø–∫–∞: $OUTPUT_DIR"
        python scripts/simple_merge.py   # –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ —Å–∫—Ä–∏–ø—Ç –ª–µ–∂–∏—Ç –≤ scripts/

    - name: üìÑ Verify merged.txt exists
      run: |
        if [ ! -f "$OUTPUT_DIR/merged.txt" ]; then
          echo "‚ùå merged.txt not found!"
          exit 1
        fi
        echo "merged.txt –≥–æ—Ç–æ–≤, —Å—Ç—Ä–æ–∫: $(wc -l < $OUTPUT_DIR/merged.txt)"
        echo "–ü–µ—Ä–≤—ã–µ 5 —Å—Ç—Ä–æ–∫ merged.txt:"
        head -n 5 "$OUTPUT_DIR/merged.txt"
    - name: üßπ Clear cache and disable notworkers
      run: |
       rm -f .checker_cache.json
       if [ -f confs/notworkers ]; then
         mv confs/notworkers confs/notworkers.bak
        echo "notworkers –æ—Ç–∫–ª—é—á—ë–Ω (–ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω)"
        fi
    - name: üîç Run vless_checker (very relaxed)
      env:
        MODE: single
        STRONG_STYLE_TEST: 'false'
        MIN_SUCCESSFUL_URLS: 1
        REQUESTS_PER_URL: 1
        REQUIRE_HTTPS: 'false'        # –∏–ª–∏ 'true', –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç HTTPS
        MAX_RESPONSE_TIME: 15
        MAX_LATENCY_MS: 5000           # –∏–ª–∏ 0 (–æ—Ç–∫–ª—é—á–∏—Ç—å)
        STABILITY_CHECKS: 1
      run: python vless_checker.py "$OUTPUT_DIR/merged.txt"

    - name: üìå Add checked files to git
      run: |
        git add confs/available "confs/available(top100)" confs/notworkers || true

    - name: üíæ Commit and push changes
      run: |
        echo "üíæ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π..."
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git config --local pull.rebase true

        if [ -d "$OUTPUT_DIR" ]; then
          echo "üìÅ –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∞–π–ª—ã –∏–∑ –ø–∞–ø–∫–∏: $OUTPUT_DIR"
          git add "$OUTPUT_DIR"/*
        fi
        git add README.md

        if git diff --cached --quiet; then
          echo "üîÑ –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
          exit 0
        fi

        MOSCOW_TIME=$(TZ='Europe/Moscow' date '+%H:%M | %d.%m.%Y')
        git commit -m "ü§ñ –ê–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: $MOSCOW_TIME"

        echo "üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å —É–¥–∞–ª–µ–Ω–Ω—ã–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–º..."
        git pull --rebase origin main || (git rebase --abort && git pull origin main --strategy-option ours)

        echo "üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è..."
        MAX_RETRIES=3
        RETRY_DELAY=10
        for i in $(seq 1 $MAX_RETRIES); do
          echo "–ü–æ–ø—ã—Ç–∫–∞ $i –∏–∑ $MAX_RETRIES..."
          if git push origin main; then
            echo "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã"
            break
          else
            echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ, –ø–æ–ø—ã—Ç–∫–∞ $i –Ω–µ —É–¥–∞–ª–∞—Å—å"
            if [ $i -lt $MAX_RETRIES ]; then
              echo "‚è≥ –ñ–¥–µ–º $RETRY_DELAY —Å–µ–∫—É–Ω–¥..."
              sleep $RETRY_DELAY
              git pull origin main --rebase
            else
              echo "üí• –í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–µ —É–¥–∞–ª–∏—Å—å"
              exit 1
            fi
          fi
        done
