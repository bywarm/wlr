name: Update confs Hourly

on:
  schedule:
    - cron: '0 */2 * * *'
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      folder_name:
        description: '–ò–º—è –ø–∞–ø–∫–∏ –¥–ª—è –∫–æ–Ω—Ñ–∏–≥–æ–≤'
        required: false
        default: 'confs'

env:
  # –û–±—â–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–æ—Å—Ç–æ–≥–æ –º–µ—Ä–∂-—Å–∫—Ä–∏–ø—Ç–∞
  MY_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  GITVERSE_TOKEN: ${{ secrets.GITVERSE_TOKEN }}
  CLOUD_RU_SECRET_KEY: ${{ secrets.CLOUD_RU_SECRET_KEY }}
  OUTPUT_DIR: ${{ github.event.inputs.folder_name || 'confs' }}

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write

    steps:
    - name: ‚¨áÔ∏è Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: pip

    - name: üì¶ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install PyGithub requests urllib3 boto3 aiohttp tqdm pyyaml PySocks python-dotenv rich pydantic

    - name: üöÄ Run merge script
      run: |
        echo "üïê –ó–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞..."
        echo "üìÅ –ò—Å–ø–æ–ª—å–∑—É–µ–º–∞—è –ø–∞–ø–∫–∞: $OUTPUT_DIR"
        python scripts/simple_merge.py

    - name: üìÑ Verify merged.txt exists
      run: |
        if [ ! -f "$OUTPUT_DIR/merged.txt" ]; then
          echo "‚ùå merged.txt not found!"
          exit 1
        fi
        echo "merged.txt –≥–æ—Ç–æ–≤, —Å—Ç—Ä–æ–∫: $(wc -l < $OUTPUT_DIR/merged.txt)"
        echo "–ü–µ—Ä–≤—ã–µ 5 —Å—Ç—Ä–æ–∫ merged.txt:"
        head -n 5 "$OUTPUT_DIR/merged.txt"

    - name: üíæ Commit and push changes
      run: |
        echo "üíæ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π..."
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git config --local pull.rebase true

        if [ -d "$OUTPUT_DIR" ]; then
          echo "üìÅ –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∞–π–ª—ã –∏–∑ –ø–∞–ø–∫–∏: $OUTPUT_DIR"
          git add "$OUTPUT_DIR"/*
        fi
        git add README.md

        if git diff --cached --quiet; then
          echo "üîÑ –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
          exit 0
        fi

        MOSCOW_TIME=$(TZ='Europe/Moscow' date '+%H:%M | %d.%m.%Y')
        git commit -m "ü§ñ –ê–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: $MOSCOW_TIME"

        echo "üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å —É–¥–∞–ª–µ–Ω–Ω—ã–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–º..."
        git pull --rebase origin main || (git rebase --abort && git pull origin main --strategy-option ours)

        echo "üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è..."
        MAX_RETRIES=3
        RETRY_DELAY=10
        for i in $(seq 1 $MAX_RETRIES); do
          echo "–ü–æ–ø—ã—Ç–∫–∞ $i –∏–∑ $MAX_RETRIES..."
          if git push origin main; then
            echo "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã"
            break
          else
            echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ, –ø–æ–ø—ã—Ç–∫–∞ $i –Ω–µ —É–¥–∞–ª–∞—Å—å"
            if [ $i -lt $MAX_RETRIES ]; then
              echo "‚è≥ –ñ–¥–µ–º $RETRY_DELAY —Å–µ–∫—É–Ω–¥..."
              sleep $RETRY_DELAY
              git pull origin main --rebase
            else
              echo "üí• –í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–µ —É–¥–∞–ª–∏—Å—å"
              exit 1
            fi
          fi
        done
