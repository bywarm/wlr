name: CIDR Whitelist Check

on:
  workflow_run:
    workflows: ["Daily VLESS check"]  # имя основного workflow
    types: [completed]
    branches: [main]
  workflow_dispatch:  # возможность ручного запуска

env:
  # Переменные для проверки (без speedtest)
  MODE: single
  OUTPUT_FILE: white-list_available
  OUTPUT_DIR: confs
  OUTPUT_ADD_DATE: 'false'
  MAX_WORKERS: 200
  EXPORT_FORMAT: txt
  ENABLE_CACHE: 'false'
  TEST_URLS: http://www.google.com/generate_204,http://www.cloudflare.com/cdn-cgi/trace
  TEST_URLS_HTTPS: https://www.gstatic.com/generate_204
  REQUIRE_HTTPS: 'true'
  STRONG_STYLE_TEST: 'true'
  STRONG_STYLE_TIMEOUT: 12
  STRONG_MAX_RESPONSE_TIME: 3
  STRONG_DOUBLE_CHECK: 'true'
  STRONG_ATTEMPTS: 3
  REQUESTS_PER_URL: 2
  MIN_SUCCESSFUL_REQUESTS: 2
  MIN_SUCCESSFUL_URLS: 2
  REQUEST_DELAY: 0.1
  CONNECT_TIMEOUT: 6
  CONNECT_TIMEOUT_SLOW: 15
  USE_ADAPTIVE_TIMEOUT: 'false'
  MAX_RETRIES: 1
  MAX_RESPONSE_TIME: 6
  MIN_RESPONSE_SIZE: 0
  MAX_LATENCY_MS: 2000
  VERIFY_HTTPS_SSL: 'false'
  STABILITY_CHECKS: 2
  STABILITY_CHECK_DELAY: 2.0
  STRICT_MODE: 'true'
  STRICT_MODE_REQUIRE_ALL: 'true'
  TEST_POST_REQUESTS: 'false'

jobs:
  cidr-check:
    if: github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 90
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 1

      - name: Ensure .env exists
        run: touch .env

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: docker compose build

      - name: Run checker in Docker (CIDR whitelist)
        env:
          # URL до файла available в текущем репозитории
          AVAILABLE_URL: https://raw.githubusercontent.com/${{ github.repository }}/main/confs/available
        run: |
          # Создаём метку времени для проверки обновления
          touch .before-docker-run
          
          # Запускаем контейнер, передавая все переменные окружения
          docker compose run --rm \
            -e MODE="$MODE" \
            -e OUTPUT_FILE="$OUTPUT_FILE" \
            -e OUTPUT_DIR="$OUTPUT_DIR" \
            -e OUTPUT_ADD_DATE="$OUTPUT_ADD_DATE" \
            -e MAX_WORKERS="$MAX_WORKERS" \
            -e EXPORT_FORMAT="$EXPORT_FORMAT" \
            -e ENABLE_CACHE="$ENABLE_CACHE" \
            -e TEST_URLS="$TEST_URLS" \
            -e TEST_URLS_HTTPS="$TEST_URLS_HTTPS" \
            -e REQUIRE_HTTPS="$REQUIRE_HTTPS" \
            -e STRONG_STYLE_TEST="$STRONG_STYLE_TEST" \
            -e STRONG_STYLE_TIMEOUT="$STRONG_STYLE_TIMEOUT" \
            -e STRONG_MAX_RESPONSE_TIME="$STRONG_MAX_RESPONSE_TIME" \
            -e STRONG_DOUBLE_CHECK="$STRONG_DOUBLE_CHECK" \
            -e STRONG_ATTEMPTS="$STRONG_ATTEMPTS" \
            -e REQUESTS_PER_URL="$REQUESTS_PER_URL" \
            -e MIN_SUCCESSFUL_REQUESTS="$MIN_SUCCESSFUL_REQUESTS" \
            -e MIN_SUCCESSFUL_URLS="$MIN_SUCCESSFUL_URLS" \
            -e REQUEST_DELAY="$REQUEST_DELAY" \
            -e CONNECT_TIMEOUT="$CONNECT_TIMEOUT" \
            -e CONNECT_TIMEOUT_SLOW="$CONNECT_TIMEOUT_SLOW" \
            -e USE_ADAPTIVE_TIMEOUT="$USE_ADAPTIVE_TIMEOUT" \
            -e MAX_RETRIES="$MAX_RETRIES" \
            -e MAX_RESPONSE_TIME="$MAX_RESPONSE_TIME" \
            -e MIN_RESPONSE_SIZE="$MIN_RESPONSE_SIZE" \
            -e MAX_LATENCY_MS="$MAX_LATENCY_MS" \
            -e VERIFY_HTTPS_SSL="$VERIFY_HTTPS_SSL" \
            -e STABILITY_CHECKS="$STABILITY_CHECKS" \
            -e STABILITY_CHECK_DELAY="$STABILITY_CHECK_DELAY" \
            -e STRICT_MODE="$STRICT_MODE" \
            -e STRICT_MODE_REQUIRE_ALL="$STRICT_MODE_REQUIRE_ALL" \
            -e TEST_POST_REQUESTS="$TEST_POST_REQUESTS" \
            vless-checker "$AVAILABLE_URL"

      - name: Verify output and create top100
        run: |
          # Проверяем, создан ли основной файл
          if [ ! -f "confs/$OUTPUT_FILE" ]; then
            echo "::error::Output file confs/$OUTPUT_FILE not found!"
            exit 1
          fi

          # Если файл не обновлён (дата старого файла позже времени запуска), предупреждаем
          if [ -f .before-docker-run ] && [ .before-docker-run -nt "confs/$OUTPUT_FILE" ]; then
            echo "::warning::Output file was not updated (checker returned 0 results or wrote elsewhere)"
          fi

          # Создаём top100, если его нет
          if [ ! -f "confs/${OUTPUT_FILE}(top100)" ]; then
            echo "Creating top100 file from first 100 lines"
            head -n 100 "confs/$OUTPUT_FILE" > "confs/${OUTPUT_FILE}(top100)"
          fi

          rm -f .before-docker-run
          echo "Output files:"
          ls -la "confs/$OUTPUT_FILE" "confs/${OUTPUT_FILE}(top100)"

      - name: Commit and push results
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Добавляем оба файла
          git add "confs/$OUTPUT_FILE" "confs/${OUTPUT_FILE}(top100)" || true

          # Обновляем last-updated.json, если используется
          if [ -f "confs/last-updated.json" ]; then
            NOW=$(date -u +%Y-%m-%dT%H:%M:%SZ)
            C=$(wc -l < "confs/$OUTPUT_FILE" 2>/dev/null || echo "0")
            C100=$(wc -l < "confs/${OUTPUT_FILE}(top100)" 2>/dev/null || echo "0")
            # Используем jq для обновления (должен быть установлен в runner)
            jq --arg t "$NOW" --argjson c "$C" --argjson c100 "$C100" \
              '.["confs/white-list_available"] = {updated: $t, count: $c} | .["confs/white-list_available(top100)"] = {updated: $t, count: $c100}' \
              confs/last-updated.json > tmp.json && mv tmp.json confs/last-updated.json
            git add confs/last-updated.json
          fi

          # Коммитим и пушим, если есть изменения
          if ! git diff --cached --quiet; then
            git commit -m "update white-list_available and top100 [CIDR check, automated]"
            git pull --rebase origin main
            git push
          else
            echo "No changes to commit"
          fi
